#!/bin/bash

# MyFVM - Fix git configuration for Flutter installations
# Fixes "unknown source" warnings in flutter doctor

echo "üîß MyFVM - Fixing Flutter Git Configuration"
echo "=========================================="
echo ""

FLUTTER_DIR="$HOME/flutter"
FVM_DIR="$HOME/.fvm"

# Function to fix git config for a Flutter installation
fix_flutter_git() {
    local version_dir=$1
    local version_name=$(basename "$version_dir")
    
    echo "üîß Fixing git configuration for $version_name..."
    
    if [ -d "$version_dir/.git" ]; then
        cd "$version_dir"
        
        # Check if this is actually a Flutter repository
        local current_remote=$(git remote get-url origin 2>/dev/null || echo "")
        if [[ "$current_remote" == *"flutter/flutter"* ]]; then
            echo "‚úÖ $version_name already has correct Flutter remote"
            # Still apply additional fixes
        fi
        
        # If it's pointing to wrong repository, we need to reinstall
        if [[ "$current_remote" == *"myfvm"* ]] || [[ "$current_remote" == *"Souieh"* ]]; then
            echo "‚ùå $version_name is corrupted (pointing to MyFVM repository)"
            echo "   This installation needs to be reinstalled."
            echo "   Run: myfvm.sh uninstall $version_name && myfvm.sh install $version_name"
            return 1
        fi
        
        # Set proper git remotes
        git remote set-url origin https://github.com/flutter/flutter.git 2>/dev/null || true
        git remote add upstream https://github.com/flutter/flutter.git 2>/dev/null || true
        git config remote.origin.url https://github.com/flutter/flutter.git 2>/dev/null || true
        git config remote.upstream.url https://github.com/flutter/flutter.git 2>/dev/null || true
        
        # Set Flutter channel to stable
        echo "stable" > .flutter-version 2>/dev/null || true
        
        # Set environment variable to dismiss the warning
        echo "export FLUTTER_GIT_URL=https://github.com/flutter/flutter.git" >> ~/.bashrc 2>/dev/null || true
        
        echo "‚úÖ Fixed git configuration for $version_name"
    else
        echo "‚ùå No git repository found in $version_name"
    fi
}

# Fix all Flutter installations
if [ -d "$FLUTTER_DIR" ]; then
    echo "üìÅ Found Flutter installations in $FLUTTER_DIR"
    echo ""
    
    for version_dir in "$FLUTTER_DIR"/flutter-*; do
        if [ -d "$version_dir" ]; then
            fix_flutter_git "$version_dir"
        fi
    done
else
    echo "‚ùå No Flutter installations found in $FLUTTER_DIR"
    exit 1
fi

echo ""
echo "‚úÖ Git configuration fixed for all Flutter installations!"
echo ""
echo "Now run 'flutter doctor' to verify the fix."
echo "The 'unknown source' warnings should be resolved."
